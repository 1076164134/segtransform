# é£æ¡¨å­¦ä¹ èµ›ï¼šé¥æ„Ÿå½±åƒåœ°å—åˆ†å‰² - 22å¹´8æœˆç¬¬6å

### èµ›é¢˜ä»‹ç»
æœ¬èµ›é¢˜ç”± 2020 CCF BDCI é¥æ„Ÿå½±åƒåœ°å—åˆ†å‰² åˆèµ›èµ›é¢˜æ”¹ç¼–è€Œæ¥ã€‚é¥æ„Ÿå½±åƒåœ°å—åˆ†å‰², æ—¨åœ¨å¯¹é¥æ„Ÿå½±åƒè¿›è¡Œåƒç´ çº§å†…å®¹è§£æï¼Œå¯¹é¥æ„Ÿå½±åƒä¸­æ„Ÿå…´è¶£çš„ç±»åˆ«è¿›è¡Œæå–å’Œåˆ†ç±»ï¼Œåœ¨åŸä¹¡è§„åˆ’ã€é˜²æ±›æ•‘ç¾ç­‰é¢†åŸŸå…·æœ‰å¾ˆé«˜çš„å®ç”¨ä»·å€¼ï¼Œåœ¨å·¥ä¸šç•Œä¹Ÿå—åˆ°äº†å¹¿æ³›å…³æ³¨ã€‚ç°æœ‰çš„é¥æ„Ÿå½±åƒåœ°å—åˆ†å‰²æ•°æ®å¤„ç†æ–¹æ³•å±€é™äºç‰¹å®šçš„åœºæ™¯å’Œç‰¹å®šçš„æ•°æ®æ¥æºï¼Œä¸”ç²¾åº¦æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚å› æ­¤åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä»ç„¶å¤§é‡ä¾èµ–äºäººå·¥å¤„ç†ï¼Œéœ€è¦æ¶ˆè€—å¤§é‡çš„äººåŠ›ã€ç‰©åŠ›ã€è´¢åŠ›ã€‚æœ¬èµ›é¢˜æ—¨åœ¨è¡¡é‡é¥æ„Ÿå½±åƒåœ°å—åˆ†å‰²æ¨¡å‹åœ¨å¤šä¸ªç±»åˆ«ï¼ˆå¦‚å»ºç­‘ã€é“è·¯ã€æ—åœ°ç­‰ï¼‰ä¸Šçš„æ•ˆæœï¼Œåˆ©ç”¨äººå·¥æ™ºèƒ½æŠ€æœ¯ï¼Œå¯¹å¤šæ¥æºã€å¤šåœºæ™¯çš„å¼‚æ„é¥æ„Ÿå½±åƒæ•°æ®è¿›è¡Œå……åˆ†æŒ–æ˜ï¼Œæ‰“é€ é«˜æ•ˆã€å®ç”¨çš„ç®—æ³•ï¼Œæé«˜é¥æ„Ÿå½±åƒçš„åˆ†ææå–èƒ½åŠ›ã€‚
èµ›é¢˜ä»»åŠ¡
æœ¬èµ›é¢˜æ—¨åœ¨å¯¹é¥æ„Ÿå½±åƒè¿›è¡Œåƒç´ çº§å†…å®¹è§£æï¼Œå¹¶å¯¹é¥æ„Ÿå½±åƒä¸­æ„Ÿå…´è¶£çš„ç±»åˆ«è¿›è¡Œæå–å’Œåˆ†ç±»ï¼Œä»¥è¡¡é‡é¥æ„Ÿå½±åƒåœ°å—åˆ†å‰²æ¨¡å‹åœ¨å¤šä¸ªç±»åˆ«ï¼ˆå¦‚å»ºç­‘ã€é“è·¯ã€æ—åœ°ç­‰ï¼‰ä¸Šçš„æ•ˆæœã€‚

### æ•°æ®è¯´æ˜
æœ¬èµ›é¢˜æä¾›äº†å¤šä¸ªåœ°åŒºå·²è„±æ•çš„é¥æ„Ÿå½±åƒæ•°æ®ï¼Œå„å‚èµ›é€‰æ‰‹å¯ä»¥åŸºäºè¿™äº›æ•°æ®æ„å»ºè‡ªå·±çš„åœ°å—åˆ†å‰²æ¨¡å‹ã€‚

### è®­ç»ƒæ•°æ®é›†
æ ·ä¾‹å›¾ç‰‡åŠå…¶æ ‡æ³¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://ai-studio-static-online.cdn.bcebos.com/8087a965609d48a19a5e60f0330fa9054d04097644de48ffa3d557e7a8ad64ad)
![](https://ai-studio-static-online.cdn.bcebos.com/d18664ecf0514cb686c95958d30bbf8a2f5efb0691bc4d66a5f6317ab511d6d0)

![](https://ai-studio-static-online.cdn.bcebos.com/e42f2c222f204094ac3a0ea8582ca331b0452fb2b1704eabaae379d499906977)
![](https://ai-studio-static-online.cdn.bcebos.com/d5260bd5a820486a85aeb2105adfb6fa10284bd94453459f892755bc43e10b8a)


è®­ç»ƒæ•°æ®é›†æ–‡ä»¶åç§°ï¼štrain_and_label.zip

åŒ…å«2ä¸ªå­æ–‡ä»¶ï¼Œåˆ†åˆ«ä¸ºï¼šè®­ç»ƒæ•°æ®é›†ï¼ˆåŸå§‹å›¾ç‰‡ï¼‰æ–‡ä»¶ã€è®­ç»ƒæ•°æ®é›†ï¼ˆæ ‡æ³¨å›¾ç‰‡ï¼‰æ–‡ä»¶ï¼Œè¯¦ç»†ä»‹ç»å¦‚ä¸‹ï¼š

* **è®­ç»ƒæ•°æ®é›†**ï¼ˆåŸå§‹å›¾ç‰‡ï¼‰æ–‡ä»¶åç§°ï¼šimg_train

	åŒ…å«66,653å¼ åˆ†è¾¨ç‡ä¸º2m/pixelï¼Œå°ºå¯¸ä¸º256 * 256çš„JPGå›¾ç‰‡ï¼Œæ¯å¼ å›¾ç‰‡çš„åç§°å½¢å¦‚T000123.jpgã€‚
* **è®­ç»ƒæ•°æ®é›†**ï¼ˆæ ‡æ³¨å›¾ç‰‡ï¼‰æ–‡ä»¶åç§°ï¼šlab_train

	åŒ…å«66,653å¼ åˆ†è¾¨ç‡ä¸º2m/pixelï¼Œå°ºå¯¸ä¸º256 * 256çš„PNGå›¾ç‰‡ï¼Œæ¯å¼ å›¾ç‰‡çš„åç§°å½¢å¦‚T000123.pngã€‚
* **æ ‡ç­¾è¯´æ˜**ï¼š å…¨éƒ¨PNGå›¾ç‰‡å…±åŒ…æ‹¬4ç§åˆ†ç±»ï¼Œåƒç´ å€¼åˆ†åˆ«ä¸º0ã€1ã€2ã€3ã€‚æ­¤å¤–ï¼Œåƒç´ å€¼255ä¸ºæœªæ ‡æ³¨åŒºåŸŸï¼Œè¡¨ç¤ºå¯¹åº”åŒºåŸŸçš„æ‰€å±ç±»åˆ«å¹¶ä¸ç¡®å®šï¼Œåœ¨è¯„æµ‹ä¸­ä¹Ÿä¸ä¼šè€ƒè™‘è¿™éƒ¨åˆ†åŒºåŸŸã€‚

### æ¯”èµ›é¡¹ç›®å…³é”®ç‚¹

æœ¬æ¯”èµ›å®è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªè¯­ä¹‰åˆ†å‰²çš„ä»»åŠ¡ï¼Œä½†æ˜¯åœ¨äºç±»ä¸ç±»ä¹‹é—´çš„åˆ†å‰²ç•Œé¢ä¸å®¹æ˜“åŒºåˆ†ï¼Œå¯¹æ¨¡å‹çš„è¯­ä¹‰æ„ŸçŸ¥å’Œç†è§£èƒ½åŠ›ä¸Šæœ‰è¦æ±‚ã€‚

å…¶æ¬¡ç”±äºè¯¥æ•°æ®é›†ç±»ä¸ç±»ä¹‹é—´ç•Œé™æ¯”è¾ƒæ¨¡ç³Šï¼Œå¹¶ä¸”ç±»åˆ«å½¢çŠ¶çš„ä¸è§„åˆ™ï¼Œç»™åˆ†å‰²ä»»åŠ¡å¸¦æ¥ä¸€å®šçš„æŒ‘æˆ˜éš¾åº¦ã€‚
                                  
### æ¨¡å‹ä»‹ç»

æ¯”èµ›ä½¿ç”¨çš„æ¨¡å‹ä¸ºï¼š**SegFormer**

SegFormeræ˜¯ä¸€æ¬¾åŸºäºTransformeræ„å»ºçš„å…·æœ‰ç®€å•ç»“æ„çš„è¯­ä¹‰åˆ†å‰²ç½‘ç»œï¼Œå…¶åŸºç¡€ç½‘ç»œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://ai-studio-static-online.cdn.bcebos.com/eef5b861bcfc40c7a8c6d92184d5e6a2518c2260e2ba4c0086dc15e6553a7b91)

åŸåŸºç¡€æ¨¡å‹çš„Decoderéƒ¨åˆ†ï¼Œæ˜¯ä¸€ä¸ªMLPæ¥å°†ä¸åŒç‰¹ç§å±‚è¾“å‡ºçš„ç‰¹å¾è¿›è¡Œèåˆï¼Œç„¶åç»è¿‡ä¸€ä¸ªMLPå†è¿›è¡Œä¸Šé‡‡æ ·ã€‚

å—åˆ°MSRAç»„åœ¨Xceptionä¸Šæ”¹è¿›å·¥ä½œå¯å˜å½¢å·ç§¯(Deformable-ConvNets)å¯å‘ï¼ŒDeformable-ConvNetså¯¹Xceptionåšäº†æ”¹è¿›ï¼Œèƒ½å¤Ÿè¿›ä¸€æ­¥æå‡æ¨¡å‹å­¦ä¹ èƒ½åŠ›ï¼Œæ–°çš„ç»“æ„å¦‚ä¸‹ï¼š

![](https://ai-studio-static-online.cdn.bcebos.com/21eb9ac43cd54e0f9e8f211e6c2598c4c10f9d439b6a42d39955eed46a588755)

åˆ†å‰²æ¨¡å‹åœ¨èåˆäº†è‡ªæ³¨æ„åŠ›åï¼Œä½¿å¾—åˆ†å‰²æ¨¡å‹å…·æœ‰å¯¹å›¾åƒä¿¡æ¯æ›´ç»†èŠ‚çš„æ„ŸçŸ¥ã€‚

### æ•°æ®å¢æ–¹æ³•

æœ¬é¡¹ç›®æ‰€ä½¿ç”¨çš„å¢å¼ºæ–¹æ³•ä¸»è¦å¦‚ä¸‹ï¼š

* **RandomHorizontalFlip**
* **RandomVerticalFlip**
* **RandomPaddingCrop**
* **RandomBlur**
* **RandomRotation**



### ç¯å¢ƒå®‰è£…


```python
!git clone https://gitee.com/paddlepaddle/PaddleSeg.git
```

    Cloning into 'PaddleSeg'...
    remote: Enumerating objects: 19547, done.[K
    remote: Counting objects: 100% (4516/4516), done.[K
    remote: Compressing objects: 100% (2161/2161), done.[K
    remote: Total 19547 (delta 2756), reused 3826 (delta 2290), pack-reused 15031[K
    Receiving objects: 100% (19547/19547), 345.32 MiB | 11.64 MiB/s, done.
    Resolving deltas: 100% (12616/12616), done.
    Checking connectivity... done.



```python
# å®‰è£…æ‰€éœ€ä¾èµ–é¡¹
!pip install -r PaddleSeg/requirements.txt
```

    Looking in indexes: https://pypi.tuna.tsinghua.edu.cn/simple
    Requirement already satisfied: pyyaml>=5.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from -r PaddleSeg/requirements.txt (line 1)) (5.1.2)
    Requirement already satisfied: visualdl>=2.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from -r PaddleSeg/requirements.txt (line 2)) (2.2.0)
    Requirement already satisfied: opencv-python in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from -r PaddleSeg/requirements.txt (line 3)) (4.1.1.26)
    Requirement already satisfied: tqdm in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from -r PaddleSeg/requirements.txt (line 4)) (4.36.1)
    Requirement already satisfied: filelock in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from -r PaddleSeg/requirements.txt (line 5)) (3.0.12)
    Requirement already satisfied: scipy in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from -r PaddleSeg/requirements.txt (line 6)) (1.6.3)
    Requirement already satisfied: prettytable in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from -r PaddleSeg/requirements.txt (line 7)) (0.7.2)
    Requirement already satisfied: sklearn in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from -r PaddleSeg/requirements.txt (line 8)) (0.0)
    Requirement already satisfied: numpy in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.20.3)
    Requirement already satisfied: pre-commit in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.21.0)
    Requirement already satisfied: six>=1.14.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.16.0)
    Requirement already satisfied: shellcheck-py in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (0.7.1.1)
    Requirement already satisfied: matplotlib in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2.2.3)
    Requirement already satisfied: bce-python-sdk in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (0.8.53)
    Requirement already satisfied: Flask-Babel>=1.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.0.0)
    Requirement already satisfied: requests in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2.22.0)
    Requirement already satisfied: flask>=1.1.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.1.1)
    Requirement already satisfied: flake8>=3.7.9 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (4.0.1)
    Requirement already satisfied: protobuf>=3.11.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (3.20.1)
    Requirement already satisfied: Pillow>=7.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (7.1.2)
    Requirement already satisfied: pandas in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.1.5)
    Requirement already satisfied: scikit-learn in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from sklearn->-r PaddleSeg/requirements.txt (line 8)) (0.24.2)
    Requirement already satisfied: pyflakes<2.5.0,>=2.4.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8>=3.7.9->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2.4.0)
    Requirement already satisfied: importlib-metadata<4.3 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8>=3.7.9->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (4.2.0)
    Requirement already satisfied: pycodestyle<2.9.0,>=2.8.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8>=3.7.9->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2.8.0)
    Requirement already satisfied: mccabe<0.7.0,>=0.6.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8>=3.7.9->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (0.6.1)
    Requirement already satisfied: Jinja2>=2.10.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.1.1->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (3.0.0)
    Requirement already satisfied: itsdangerous>=0.24 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.1.1->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.1.0)
    Requirement already satisfied: Werkzeug>=0.15 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.1.1->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (0.16.0)
    Requirement already satisfied: click>=5.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.1.1->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (7.0)
    Requirement already satisfied: Babel>=2.3 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from Flask-Babel>=1.0.0->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2.8.0)
    Requirement already satisfied: pytz in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from Flask-Babel>=1.0.0->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2019.3)
    Requirement already satisfied: future>=0.6.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from bce-python-sdk->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (0.18.0)
    Requirement already satisfied: pycryptodome>=3.8.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from bce-python-sdk->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (3.9.9)
    Requirement already satisfied: kiwisolver>=1.0.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.1.0)
    Requirement already satisfied: cycler>=0.10 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (0.10.0)
    Requirement already satisfied: pyparsing!=2.0.4,!=2.1.2,!=2.1.6,>=2.0.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (3.0.9)
    Requirement already satisfied: python-dateutil>=2.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2.8.2)
    Requirement already satisfied: toml in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (0.10.0)
    Requirement already satisfied: virtualenv>=15.2 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (16.7.9)
    Requirement already satisfied: aspy.yaml in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.3.0)
    Requirement already satisfied: identify>=1.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.4.10)
    Requirement already satisfied: nodeenv>=0.11.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.3.4)
    Requirement already satisfied: cfgv>=2.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2.0.1)
    Requirement already satisfied: certifi>=2017.4.17 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2019.9.11)
    Requirement already satisfied: idna<2.9,>=2.5 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2.8)
    Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (1.25.6)
    Requirement already satisfied: chardet<3.1.0,>=3.0.2 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (3.0.4)
    Requirement already satisfied: joblib>=0.11 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from scikit-learn->sklearn->-r PaddleSeg/requirements.txt (line 8)) (0.14.1)
    Requirement already satisfied: threadpoolctl>=2.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from scikit-learn->sklearn->-r PaddleSeg/requirements.txt (line 8)) (2.1.0)
    Requirement already satisfied: typing-extensions>=3.6.4 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from importlib-metadata<4.3->flake8>=3.7.9->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (4.3.0)
    Requirement already satisfied: zipp>=0.5 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from importlib-metadata<4.3->flake8>=3.7.9->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (3.8.1)
    Requirement already satisfied: MarkupSafe>=2.0.0rc2 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from Jinja2>=2.10.1->flask>=1.1.1->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (2.0.1)
    Requirement already satisfied: setuptools in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from kiwisolver>=1.0.1->matplotlib->visualdl>=2.0.0->-r PaddleSeg/requirements.txt (line 2)) (56.2.0)
    
    [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip available: [0m[31;49m22.1.2[0m[39;49m -> [0m[32;49m22.2.2[0m
    [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m


### è§£å‹æ•°æ®é›†


```python
!unzip -q data/data80164/train_and_label.zip
!unzip -q data/data80164/img_test.zip
```

### æ•°æ®å¤„ç†



```python
import os
import numpy as np

datas = []
image_base = 'img_train'   # è®­ç»ƒé›†åŸå›¾è·¯å¾„
annos_base = 'lab_train'   # è®­ç»ƒé›†æ ‡ç­¾è·¯å¾„

# è¯»å–åŸå›¾æ–‡ä»¶å
ids_ = [v.split('.')[0] for v in os.listdir(image_base)]

# å°†è®­ç»ƒé›†çš„å›¾åƒé›†å’Œæ ‡ç­¾è·¯å¾„å†™å…¥datasä¸­
for id_ in ids_:
    img_pt0 = os.path.join(image_base, '{}.jpg'.format(id_))
    img_pt1 = os.path.join(annos_base, '{}.png'.format(id_))
    datas.append((img_pt0.replace('/home/aistudio', ''), img_pt1.replace('/home/aistudio', '')))
    if os.path.exists(img_pt0) and os.path.exists(img_pt1):
        pass
    else:
        raise "path invalid!"

# æ‰“å°datasçš„é•¿åº¦å’Œå…·ä½“å­˜å‚¨ä¾‹å­
print('total:', len(datas))
print(datas[0][0])
print(datas[0][1])
print(datas[10][:])
```

    total: 66652
    img_train/T053746.jpg
    lab_train/T053746.png
    ('img_train/T084102.jpg', 'lab_train/T084102.png')



```python
import numpy as np

# å››ç±»æ ‡ç­¾ï¼Œè¿™é‡Œç”¨å¤„ä¸å¤§ï¼Œæ¯”èµ›è¯„æµ‹æ˜¯ä»¥0ã€1ã€2ã€3ç±»æ¥å¯¹æ¯”è¯„æµ‹çš„
labels = ['å»ºç­‘', 'è€•åœ°', 'æ—åœ°',  'å…¶ä»–']

# å°†labelså†™å…¥æ ‡ç­¾æ–‡ä»¶
with open('labels.txt', 'w') as f:
    for v in labels:
        f.write(v+'\n')

# éšæœºæ‰“ä¹±datas
np.random.seed(5)
np.random.shuffle(datas)

# éªŒè¯é›†ä¸è®­ç»ƒé›†çš„åˆ’åˆ†ï¼Œ0.05è¡¨ç¤º5%ä¸ºè®­ç»ƒé›†ï¼Œ95%ä¸ºè®­ç»ƒé›†
split_num = int(0.05*len(datas))

# åˆ’åˆ†è®­ç»ƒé›†å’ŒéªŒè¯é›†
train_data = datas[:-split_num]
valid_data = datas[-split_num:]

# å†™å…¥è®­ç»ƒé›†list
with open('train_list.txt', 'w') as f:
    for img, lbl in train_data:
        f.write(img + ' ' + lbl + '\n')

# å†™å…¥éªŒè¯é›†list
with open('valid_list.txt', 'w') as f:
    for img, lbl in valid_data:
        f.write(img + ' ' + lbl + '\n')

# æ‰“å°è®­ç»ƒé›†å’Œæµ‹è¯•é›†å¤§å°
print('train:', len(train_data))
print('valid:', len(valid_data))
```

    train: 63320
    valid: 3332


### æ¨¡å‹è°ƒå‚

* **train_batch_size (int)**: è®­ç»ƒæ•°æ®batchå¤§å°ã€‚åŒæ—¶ä½œä¸ºéªŒè¯æ•°æ®batchå¤§å°ã€‚é»˜è®¤2ã€‚
* **eval_dataset (paddlex.datasets)**: è¯„ä¼°æ•°æ®è¯»å–å™¨ã€‚
* **save_interval_epochs (int)**: æ¨¡å‹ä¿å­˜é—´éš”ï¼ˆå•ä½ï¼šè¿­ä»£è½®æ•°ï¼‰ã€‚é»˜è®¤ä¸º1ã€‚
* **log_interval_steps (int)**: è®­ç»ƒæ—¥å¿—è¾“å‡ºé—´éš”ï¼ˆå•ä½ï¼šè¿­ä»£æ¬¡æ•°ï¼‰ã€‚é»˜è®¤ä¸º2ã€‚
* **save_dir (str)**: æ¨¡å‹ä¿å­˜è·¯å¾„ã€‚é»˜è®¤â€™outputâ€™
* **pretrain_weights (str)**: è‹¥æŒ‡å®šä¸ºè·¯å¾„æ—¶ï¼Œåˆ™åŠ è½½è·¯å¾„ä¸‹é¢„è®­ç»ƒæ¨¡å‹ã€‚
* **optimizer (paddle.fluid.optimizer)**: ä¼˜åŒ–å™¨ã€‚å½“è¯¥å‚æ•°ä¸ºNoneæ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„ä¼˜åŒ–å™¨ï¼šä½¿ç”¨fluid.optimizer.Momentumä¼˜åŒ–æ–¹æ³•çš„å­¦ä¹ ç‡è¡°å‡ç­–ç•¥ã€‚
* **learning_rate (float)**: é»˜è®¤ä¼˜åŒ–å™¨çš„åˆå§‹å­¦ä¹ ç‡ã€‚é»˜è®¤0.01ã€‚
* **lr_decay_power (float)**: é»˜è®¤ä¼˜åŒ–å™¨å­¦ä¹ ç‡è¡°å‡æŒ‡æ•°ã€‚é»˜è®¤0.9ã€‚
* **use_vdl (bool)**: æ˜¯å¦ä½¿ç”¨VisualDLè¿›è¡Œå¯è§†åŒ–ã€‚é»˜è®¤Falseã€‚
* **sensitivities_file (str)**: è‹¥æŒ‡å®šä¸ºè·¯å¾„æ—¶ï¼Œåˆ™åŠ è½½è·¯å¾„ä¸‹æ•æ„Ÿåº¦ä¿¡æ¯è¿›è¡Œè£å‰ªï¼›è‹¥ä¸ºå­—ç¬¦ä¸²â€™DEFAULTâ€™ï¼Œåˆ™è‡ªåŠ¨ä¸‹è½½åœ¨Cityscapeså›¾ç‰‡æ•°æ®ä¸Šè·å¾—çš„æ•æ„Ÿåº¦ä¿¡æ¯è¿›è¡Œè£å‰ªï¼›è‹¥ä¸ºNoneï¼Œåˆ™ä¸è¿›è¡Œè£å‰ªã€‚é»˜è®¤ä¸ºNoneã€‚
* **eval_metric_loss (float)**: å¯å®¹å¿çš„ç²¾åº¦æŸå¤±ã€‚é»˜è®¤ä¸º0.05ã€‚
* **early_stop (bool)**: æ˜¯å¦ä½¿ç”¨æå‰ç»ˆæ­¢è®­ç»ƒç­–ç•¥ã€‚é»˜è®¤å€¼ä¸ºFalseã€‚
* **early_stop_patience (int)**: å½“ä½¿ç”¨æå‰ç»ˆæ­¢è®­ç»ƒç­–ç•¥æ—¶ï¼Œå¦‚æœéªŒè¯é›†ç²¾åº¦åœ¨early_stop_patienceä¸ªepochå†…è¿ç»­ä¸‹é™æˆ–æŒå¹³ï¼Œåˆ™ç»ˆæ­¢è®­ç»ƒã€‚

### æ¨¡å‹è®­ç»ƒ


**æ›´æ”¹è®­ç»ƒæ–‡ä»¶ PaddleSeg/paddleseg/core/train.py**

```
def train(model,
          train_dataset,
          val_dataset=None,
          optimizer=None,
          save_dir='output',
          iters=10000,
          batch_size=2,
          resume_model=None,
          save_interval=1000,
          log_iters=10,
          num_workers=0,
          use_vdl=False,
          losses=None,
          keep_checkpoint_max=5)
```

**é…ç½®æ¨¡å‹æ–‡ä»¶ï¼šPaddleSeg/configs/deeplabv3p/deeplabv3p_resnet101_os8_cityscapes_1024x512_80k.yml**
```
_base_: '../_base_/cityscapes.yml'

batch_size: 2
iters: 20000

model:
  type: DeepLabV3P
  backbone:
    type: ResNet101_vd
    output_stride: 8
    multi_grid: [1, 2, 4]
    pretrained: https://bj.bcebos.com/paddleseg/dygraph/resnet101_vd_ssld_v2.tar.gz  #åŠ è½½é¢„è®­ç»ƒæƒé‡æ–‡ä»¶
  num_classes: 4
  backbone_indices: [0, 3]
  aspp_ratios: [1, 12, 24, 36]
  aspp_out_channels: 256
  align_corners: False
  pretrained: null
```
**é…ç½®è®­ç»ƒæ•°æ®é›†æ–‡ä»¶ï¼šPaddleSeg/configs/_base_/cityscapes.yml**
```
train_dataset:
  type: Dataset
  dataset_root: /home/aistudio
  train_path: /home/aistudio/train_list.txt
  num_classes: 4
  transforms:
    - type: ResizeStepScaling
      min_scale_factor: 0.5
      max_scale_factor: 2.0
      scale_step_size: 0.25
    - type: RandomPaddingCrop
      crop_size: [1024, 512]
    - type: RandomHorizontalFlip
    - type: RandomDistort
      brightness_range: 0.4
      contrast_range: 0.4
      saturation_range: 0.4
    - type: Normalize
  mode: train

val_dataset:
  type: Dataset
  dataset_root: /home/aistudio
  val_path: /home/aistudio/valid_list.txt
  num_classes: 4
  transforms:
    - type: Normalize
  mode: val


optimizer:
  type: sgd
  momentum: 0.9
  weight_decay: 4.0e-5

learning_rate:
  value: 0.0001
  decay:
    type: poly
    power: 0.9
    end_lr: 0.0

loss:
  types:
    - type: CrossEntropyLoss
  coef: [1]
```

### å¼€å§‹è®­ç»ƒ


```python
!python PaddleSeg/train.py \
        --config PaddleSeg/configs/deeplabv3p/deeplabv3p_resnet101_os8_cityscapes_1024x512_80k.yml \
        --use_vdl \
        --do_eval \
        --save_interval 10000 \
        --save_dir output
```

### æ¨¡å‹è¯„ä¼°
> PaddleSeg/paddleseg/core/val.py
```
def evaluate(model,
             eval_dataset,
             aug_eval=False,
             scales=1.0,
             flip_horizontal=True,
             flip_vertical=False,
             is_slide=False,
             stride=None,
             crop_size=None,
             num_workers=0,
             print_detail=True)
```


```python
!python PaddleSeg/val.py \
        --config PaddleSeg/configs/deeplabv3p/deeplabv3p_resnet101_os8_cityscapes_1024x512_80k.yml \
        --model_path PaddleSeg/output/best_model/model.pdparams 
```

### æ¨¡å‹é¢„æµ‹

> PaddleSeg/paddleseg/core/predict.py


```
def predict(model,
            model_path,
            transforms,
            image_list,
            image_dir=None,
            save_dir='output',
            aug_pred=False,
            scales=1.0,
            flip_horizontal=True,
            flip_vertical=False,
            is_slide=False,
            stride=None,
            crop_size=None)
```
```
pred_im = utils.visualize(im_path, pred, weight=0.0)
result_saved_path = os.path.join(result_saved_dir, im_file)
mkdir(result_saved_path)
cv2.imwrite(pred_saved_path, pred_im)
```


```python
!python PaddleSeg/predict.py \
       --config PaddleSeg/configs/deeplabv3p/deeplabv3p_resnet101_os8_cityscapes_1024x512_80k.yml \
       --model_path output/best_model/model.pdparams \
       --image_path img_testA \
       --save_dir result
```


```python
# ç”±é¢„æµ‹ç»“æœç”Ÿæˆæäº¤æ–‡ä»¶
!zip -r result.zip result/result/
```

### æ€»ç»“

å¯¹äºè¿™ä¸ªåˆ†æ•°ï¼Œå…¶å®è¿˜è¦å¾ˆå¤šå¯ä»¥æ”¹è¿›çš„åœ°æ–¹çœ‹å…¶ä»–å¼€æºçš„æ–¹æ¡ˆã€‚
æ„Ÿè°¢ç™¾åº¦æä¾›è¿™æ ·çš„å­¦ä¹ å¹³å°ï¼ŒåŒå­¦å¯æ ¹æ®è‡ªå·±å–œæ¬¢çš„æ–¹å‘ï¼Œé€šè¿‡aistudioä¸Šçš„è¯¾ç¨‹å’Œæä¾›çš„è®­ç»ƒå¹³å°ï¼Œè¿›è¡Œç†è®ºä¸å®è·µå¹¶å­˜çš„å­¦ä¹ ã€‚
#### é£æ¡¨é¢†èˆªå›¢å®æˆ˜é€Ÿæˆè¥ï¼š[https://aistudio.baidu.com/aistudio/education/group/info/16606](https://aistudio.baidu.com/aistudio/education/group/info/16606)
#### Bç«™è§†é¢‘é“¾æ¥ï¼ˆP5ã€P6ï¼‰ï¼š[https://www.bilibili.com/video/BV1pp4y1871g](https://www.bilibili.com/video/BV1pp4y1871g)
#### å›¾åƒåˆ†å‰²é¥æ„Ÿé¡¹ç›®å®æˆ˜ï¼š[https://aistudio.baidu.com/aistudio/projectdetail/1703449](https://aistudio.baidu.com/aistudio/projectdetail/1703449)

